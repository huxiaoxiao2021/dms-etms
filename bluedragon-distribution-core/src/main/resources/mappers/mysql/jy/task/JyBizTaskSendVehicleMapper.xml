<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jd.bluedragon.distribution.jy.dao.task.JyBizTaskSendVehicleDao">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.jd.bluedragon.distribution.jy.task.JyBizTaskSendVehicleEntity" id="jyBizTaskSendVehicleMap">
        <result property="id" column="id"/>
        <result property="bizId" column="biz_id"/>
        <result property="bizNo" column="biz_no"/>
        <result property="transWorkCode" column="trans_work_code"/>
        <result property="startSiteId" column="start_site_id"/>
        <result property="vehicleNumber" column="vehicle_number"/>
        <result property="vehicleStatus" column="vehicle_status"/>
        <result property="manualCreatedFlag" column="manual_created_flag"/>
        <result property="abnormalFlag" column="abnormal_flag"/>
        <result property="bindFlag" column="bind_flag"/>
        <result property="transWay" column="trans_way"/>
        <result property="transWayName" column="trans_way_name"/>
        <result property="vehicleType" column="vehicle_type"/>
        <result property="vehicleTypeName" column="vehicle_type_name"/>
        <result property="lineType" column="line_type"/>
        <result property="lineTypeName" column="line_type_name"/>
        <result property="driverTag" column="driver_tag"/>
        <result property="lastPlanDepartTime" column="last_plan_depart_time"/>
        <result property="lastSealCarTime" column="last_seal_car_time"/>
        <result property="comeTime" column="come_time"/>
        <result property="nearComeTime" column="near_come_time"/>
        <result property="createUserErp" column="create_user_erp"/>
        <result property="createUserName" column="create_user_name"/>
        <result property="updateUserErp" column="update_user_erp"/>
        <result property="updateUserName" column="update_user_name"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="yn" column="yn"/>
        <result property="ts" column="ts"/>
        <result property="taskName" column="task_name"/>
        <result property="bookingCode" column="booking_code"/>
        <result property="taskType" column="task_type"/>
    </resultMap>

    <resultMap id="statusSumResultMap" type="com.jd.bluedragon.distribution.jy.dto.send.JyBizTaskSendCountDto">
        <result property="vehicleStatus" column="vehicle_status"/>
        <result property="total" column="total"/>
    </resultMap>

    <resultMap id="lineTypeSumResultMap" type="com.jd.bluedragon.distribution.jy.dto.send.JyBizTaskSendLineTypeCountDto">
        <result property="lineType" column="line_type"/>
        <result property="total" column="total"/>
    </resultMap>


    <resultMap type="com.jd.bluedragon.distribution.jy.dto.send.JyBizSendTaskAssociationDto" id="jyBizSendTaskAssociationDto">
        <result property="transWorkCode" column="trans_work_code"/>
        <result property="vehicleNumber" column="vehicle_number"/>
        <result property="lastPlanDepartTime" column="last_plan_depart_time"/>
        <result property="sendVehicleBizId" column="send_vehicle_biz_id"/>
        <result property="bizId" column="biz_id"/>
        <result property="transWorkItemCode" column="trans_work_item_code"/>
        <result property="vehicleStatus" column="vehicle_status"/>
        <result property="startSiteId" column="start_site_id"/>
        <result property="startSiteName" column="start_site_name"/>
        <result property="endSiteId" column="end_site_id"/>
        <result property="endSiteName" column="end_site_name"/>
    </resultMap>

    <!-- todo 空铁需求：2023.08.07 发货表增加类型字段task_type（默认1：表示发车任务）， 根据业务场景使用不同类型隔离数据-->
    <!-- todo 所有非指定bizId、非指定ID操作 都添加任务类型过滤，不同类型发货任务数据隔离  JySendTaskTypeEnum-->
    <!-- todo 空铁需求上线前历史任务都是发车任务，发车任务查询条件过滤必须添加类型过滤  -->
    <sql id="default_task_type_vehicle">
       and task_type = 1
    </sql>

    <sql id="Base_Column_List">
        id
        , biz_id,biz_no, trans_work_code, start_site_id, vehicle_number, vehicle_status, manual_created_flag, abnormal_flag,
        bind_flag, trans_way, trans_way_name, vehicle_type, vehicle_type_name, line_type, line_type_name, driver_tag, last_plan_depart_time, last_seal_car_time,come_time,near_come_time,
        create_user_erp, create_user_name, update_user_erp, update_user_name, create_time, update_time, yn, ts,task_name,
        task_type, booking_code
    </sql>

    <insert id="insert" parameterType="JyBizTaskSendVehicleEntity">
        insert into jy_biz_task_send_vehicle
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="bizId != null">
                biz_id,
            </if>
            <if test="bizNo != null">
                biz_no,
            </if>
            <if test="transWorkCode != null">
                trans_work_code,
            </if>
            <if test="startSiteId != null">
                start_site_id,
            </if>
            <if test="vehicleNumber != null">
                vehicle_number,
            </if>
            <if test="vehicleStatus != null">
                vehicle_status,
            </if>
            <if test="manualCreatedFlag != null">
                manual_created_flag,
            </if>
            <if test="abnormalFlag != null">
                abnormal_flag,
            </if>
            <if test="bindFlag != null">
                bind_flag,
            </if>
            <if test="transWay != null">
                trans_way,
            </if>
            <if test="transWayName != null">
                trans_way_name,
            </if>
            <if test="vehicleType != null">
                vehicle_type,
            </if>
            <if test="vehicleTypeName != null">
                vehicle_type_name,
            </if>
            <if test="lineType != null">
                line_type,
            </if>
            <if test="lineTypeName != null">
                line_type_name,
            </if>
            <if test="driverTag != null">
                driver_tag,
            </if>
            <if test="lastPlanDepartTime != null">
                last_plan_depart_time,
            </if>
            <if test="lastSealCarTime != null">
                last_seal_car_time,
            </if>
            <if test="comeTime != null">
                come_time,
            </if>
            <if test="nearComeTime != null">
                near_come_time,
            </if>
            <if test="createUserErp != null">
                create_user_erp,
            </if>
            <if test="createUserName != null">
                create_user_name,
            </if>
            <if test="updateUserErp != null">
                update_user_erp,
            </if>
            <if test="updateUserName != null">
                update_user_name,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="updateTime != null">
                update_time,
            </if>
            <if test="yn != null">
                yn,
            </if>
            <if test="ts != null">
                ts,
            </if>
            <if test="taskName != null">
                task_name,
            </if>
            <if test="taskType != null">
                task_type,
            </if>
            <if test="bookingCode != null">
                booking_code,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=BIGINT},
            </if>
            <if test="bizId != null">
                #{bizId,jdbcType=VARCHAR},
            </if>
            <if test="bizNo != null">
                #{bizNo,jdbcType=VARCHAR},
            </if>
            <if test="transWorkCode != null">
                #{transWorkCode,jdbcType=VARCHAR},
            </if>
            <if test="startSiteId != null">
                #{startSiteId,jdbcType=BIGINT},
            </if>
            <if test="vehicleNumber != null">
                #{vehicleNumber,jdbcType=VARCHAR},
            </if>
            <if test="vehicleStatus != null">
                #{vehicleStatus,jdbcType=BIT},
            </if>
            <if test="manualCreatedFlag != null">
                #{manualCreatedFlag,jdbcType=BIT},
            </if>
            <if test="abnormalFlag != null">
                #{abnormalFlag,jdbcType=BIT},
            </if>
            <if test="bindFlag != null">
                #{bindFlag,jdbcType=BIT},
            </if>
            <if test="transWay != null">
                #{transWay,jdbcType=TINYINT},
            </if>
            <if test="transWayName != null">
                #{transWayName,jdbcType=VARCHAR},
            </if>
            <if test="vehicleType != null">
                #{vehicleType,jdbcType=INTEGER},
            </if>
            <if test="vehicleTypeName != null">
                #{vehicleTypeName,jdbcType=VARCHAR},
            </if>
            <if test="lineType != null">
                #{lineType,jdbcType=TINYINT},
            </if>
            <if test="lineTypeName != null">
                #{lineTypeName,jdbcType=VARCHAR},
            </if>
            <if test="driverTag != null">
                #{driverTag,jdbcType=TINYINT},
            </if>
            <if test="lastPlanDepartTime != null">
                #{lastPlanDepartTime,jdbcType=TIMESTAMP},
            </if>
            <if test="lastSealCarTime != null">
                #{lastSealCarTime,jdbcType=TIMESTAMP},
            </if>
            <if test="comeTime != null">
                #{comeTime,jdbcType=TIMESTAMP},
            </if>
            <if test="nearComeTime != null">
                #{nearComeTime,jdbcType=TIMESTAMP},
            </if>
            <if test="createUserErp != null">
                #{createUserErp,jdbcType=VARCHAR},
            </if>
            <if test="createUserName != null">
                #{createUserName,jdbcType=VARCHAR},
            </if>
            <if test="updateUserErp != null">
                #{updateUserErp,jdbcType=VARCHAR},
            </if>
            <if test="updateUserName != null">
                #{updateUserName,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="yn != null">
                #{yn,jdbcType=BIT},
            </if>
            <if test="ts != null">
                #{ts,jdbcType=TIMESTAMP},
            </if>
            <if test="taskName != null">
                #{taskName,jdbcType=VARCHAR},
            </if>
            <if test="taskType != null">
                #{taskType,jdbcType=VARCHAR},
            </if>
            <if test="bookingCode != null">
                #{bookingCode,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>

    <update id="update" parameterType="JyBizTaskSendVehicleEntity">
        update jy_biz_task_send_vehicle
        <set>
            <if test="bizId != null">
                biz_id = #{bizId,jdbcType=VARCHAR},
            </if>
            <if test="bizNo != null">
                biz_no = #{bizNo,jdbcType=VARCHAR},
            </if>
            <if test="transWorkCode != null">
                trans_work_code = #{transWorkCode,jdbcType=VARCHAR},
            </if>
            <if test="startSiteId != null">
                start_site_id = #{startSiteId,jdbcType=BIGINT},
            </if>
            <if test="vehicleNumber != null">
                vehicle_number = #{vehicleNumber,jdbcType=VARCHAR},
            </if>
            <if test="vehicleStatus != null">
                vehicle_status = #{vehicleStatus,jdbcType=BIT},
            </if>
            <if test="manualCreatedFlag != null">
                manual_created_flag = #{manualCreatedFlag,jdbcType=BIT},
            </if>
            <if test="abnormalFlag != null">
                abnormal_flag = #{abnormalFlag,jdbcType=BIT},
            </if>
            <if test="bindFlag != null">
                bind_flag = #{bindFlag,jdbcType=TINYINT},
            </if>
            <if test="transWay != null">
                trans_way = #{transWay,jdbcType=TINYINT},
            </if>
            <if test="transWayName != null">
                trans_way_name = #{transWayName,jdbcType=VARCHAR},
            </if>
            <if test="vehicleType != null">
                vehicle_type = #{vehicleType,jdbcType=INTEGER},
            </if>
            <if test="vehicleTypeName != null">
                vehicle_type_name = #{vehicleTypeName,jdbcType=VARCHAR},
            </if>
            <if test="lineType != null">
                line_type = #{lineType,jdbcType=TINYINT},
            </if>
            <if test="lineTypeName != null">
                line_type_name = #{lineTypeName,jdbcType=VARCHAR},
            </if>
            <if test="driverTag != null">
                driver_tag = #{driver_tag,jdbcType=INTEGER},
            </if>
            <if test="lastPlanDepartTime != null">
                last_plan_depart_time = #{lastPlanDepartTime,jdbcType=TIMESTAMP},
            </if>
            <if test="lastSealCarTime != null">
                last_seal_car_time = #{lastSealCarTime,jdbcType=TIMESTAMP},
            </if>
            <if test="comeTime != null">
                come_time = #{comeTime,jdbcType=TIMESTAMP},
            </if>
            <if test="nearComeTime != null">
                near_come_time = #{nearComeTime,jdbcType=TIMESTAMP},
            </if>
            <if test="createUserErp != null">
                create_user_erp = #{createUserErp,jdbcType=VARCHAR},
            </if>
            <if test="createUserName != null">
                create_user_name = #{createUserName,jdbcType=VARCHAR},
            </if>
            <if test="updateUserErp != null">
                update_user_erp = #{updateUserErp,jdbcType=VARCHAR},
            </if>
            <if test="updateUserName != null">
                update_user_name = #{updateUserName,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="yn != null">
                yn = #{yn,jdbcType=BIT},
            </if>
            <if test="ts != null">
                ts = #{ts,jdbcType=TIMESTAMP},
            </if>
            <if test="taskType != null">
                task_type = #{taskType,jdbcType=VARCHAR},
            </if>
            <if test="bookingCode != null">
                booking_code = #{bookingCode,jdbcType=VARCHAR},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>

    <update id="updateByBizId" parameterType="JyBizTaskSendVehicleEntity">
        update jy_biz_task_send_vehicle
        <set>
            <if test="bizNo != null">
                biz_no = #{bizNo,jdbcType=VARCHAR},
            </if>
            <if test="taskName != null">
                task_name = #{taskName,jdbcType=VARCHAR},
            </if>
            <if test="transWorkCode != null">
                trans_work_code = #{transWorkCode,jdbcType=VARCHAR},
            </if>
            <if test="startSiteId != null">
                start_site_id = #{startSiteId,jdbcType=BIGINT},
            </if>
            <if test="vehicleNumber != null">
                vehicle_number = #{vehicleNumber,jdbcType=VARCHAR},
            </if>
            <if test="vehicleStatus != null">
                vehicle_status = #{vehicleStatus,jdbcType=BIT},
            </if>
            <if test="manualCreatedFlag != null">
                manual_created_flag = #{manualCreatedFlag,jdbcType=BIT},
            </if>
            <if test="abnormalFlag != null">
                abnormal_flag = #{abnormalFlag,jdbcType=BIT},
            </if>
            <if test="bindFlag != null">
                bind_flag = #{bindFlag,jdbcType=BIT},
            </if>
            <if test="transWay != null">
                trans_way = #{transWay,jdbcType=TINYINT},
            </if>
            <if test="transWayName != null">
                trans_way_name = #{transWayName,jdbcType=VARCHAR},
            </if>
            <if test="vehicleType != null">
                vehicle_type = #{vehicleType,jdbcType=INTEGER},
            </if>
            <if test="vehicleTypeName != null">
                vehicle_type_name = #{vehicleTypeName,jdbcType=VARCHAR},
            </if>
            <if test="lineType != null">
                line_type = #{lineType,jdbcType=TINYINT},
            </if>
            <if test="lineTypeName != null">
                line_type_name = #{lineTypeName,jdbcType=VARCHAR},
            </if>
            <if test="driverTag != null">
                driver_tag = #{driverTag,jdbcType=INTEGER},
            </if>
            <if test="lastPlanDepartTime != null">
                last_plan_depart_time = #{lastPlanDepartTime,jdbcType=TIMESTAMP},
            </if>
            <if test="lastSealCarTime != null">
                last_seal_car_time = #{lastSealCarTime,jdbcType=TIMESTAMP},
            </if>
            <if test="comeTime != null">
                come_time = #{comeTime,jdbcType=TIMESTAMP},
            </if>
            <if test="nearComeTime != null">
                near_come_time = #{nearComeTime,jdbcType=TIMESTAMP},
            </if>
            <if test="createUserErp != null">
                create_user_erp = #{createUserErp,jdbcType=VARCHAR},
            </if>
            <if test="createUserName != null">
                create_user_name = #{createUserName,jdbcType=VARCHAR},
            </if>
            <if test="updateUserErp != null">
                update_user_erp = #{updateUserErp,jdbcType=VARCHAR},
            </if>
            <if test="updateUserName != null">
                update_user_name = #{updateUserName,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="yn != null">
                yn = #{yn,jdbcType=BIT},
            </if>
            <if test="ts != null">
                ts = #{ts,jdbcType=TIMESTAMP},
            </if>
            <if test="taskType != null">
                task_type = #{taskType,jdbcType=VARCHAR},
            </if>
            <if test="bookingCode != null">
                booking_code = #{bookingCode,jdbcType=VARCHAR},
            </if>
        </set>
        where biz_id = #{bizId}
    </update>

    <update id="updateComeTimeOrNearComeTime" parameterType="JyBizTaskSendVehicleEntity">
        update jy_biz_task_send_vehicle
        <set>
            update_time = now(),
            <if test="comeTime != null">
                come_time = #{comeTime,jdbcType=TIMESTAMP},
            </if>
            <if test="nearComeTime != null">
                near_come_time = #{nearComeTime,jdbcType=TIMESTAMP},
            </if>

        </set>
        where biz_id = #{bizId} and yn = 1
        <if test="comeTime != null">
          and  ( come_time > #{comeTime,jdbcType=TIMESTAMP} or come_time is null )
        </if>
        <if test="nearComeTime != null">
          and  ( near_come_time > #{nearComeTime,jdbcType=TIMESTAMP} or near_come_time is null )
        </if>
    </update>

    <select id="findByBizId" resultMap="jyBizTaskSendVehicleMap" parameterType="java.lang.String">
        select
        <include refid="Base_Column_List"/>
        from jy_biz_task_send_vehicle
        where biz_id = #{bizId}
        limit 1;
    </select>

    <select id="findByTransWorkAndStartSite" parameterType="JyBizTaskSendVehicleEntity"
            resultMap="jyBizTaskSendVehicleMap">
        SELECT id,
               biz_id
        FROM jy_biz_task_send_vehicle
        WHERE yn = 1
          AND trans_work_code = #{transWorkCode, jdbcType=VARCHAR}
          AND start_site_id = #{startSiteId, jdbcType=BIGINT}
        ORDER BY ts DESC limit 1
    </select>

    <select id="findByTransWork" parameterType="JyBizTaskSendVehicleEntity"
      resultMap="jyBizTaskSendVehicleMap">
        SELECT id,
               biz_id,vehicle_status
        FROM jy_biz_task_send_vehicle
        WHERE yn = 1
          AND trans_work_code = #{transWorkCode, jdbcType=VARCHAR}
    </select>

    <insert id="initTaskSendVehicle" parameterType="JyBizTaskSendVehicleEntity">
        INSERT INTO jy_biz_task_send_vehicle
        (biz_id,
        trans_work_code,
        start_site_id,
        vehicle_number,
        vehicle_status,
        <if test="transWay != null">
            trans_way,
        </if>
        <if test="transWayName != null">
            trans_way_name,
        </if>
        <if test="vehicleType != null">
            vehicle_type,
        </if>
        <if test="vehicleTypeName != null">
            vehicle_type_name,
        </if>
        <if test="taskType != null">
            task_type,
        </if>
        <if test="bookingCode != null">
            booking_code,
        </if>
        line_type,
        line_type_name,
        create_user_erp,
        create_user_name,
        create_time,
        yn)
        VALUES (#{bizId},
        #{transWorkCode},
        #{startSiteId},
        #{vehicleNumber},
        #{vehicleStatus},
        <if test="transWay != null">
            #{transWay},
        </if>
        <if test="transWayName != null">
            #{transWayName},
        </if>
        <if test="vehicleType != null">
            #{vehicleType},
        </if>
        <if test="vehicleTypeName != null">
            #{vehicleTypeName},
        </if>
        <if test="taskType != null">
            #{taskType},
        </if>
        <if test="bookingCode != null">
            #{bookingCode},
        </if>
        #{lineType},
        #{lineTypeName},
        #{createUserErp},
        #{createUserName},
        NOW(),
        1)
    </insert>

    <select id="sumTaskByVehicleStatus" resultMap="statusSumResultMap">
        SELECT
        vehicle_status, COUNT(*) total
        FROM
        jy_biz_task_send_vehicle
        WHERE
        yn = 1
        <include refid="default_task_type_vehicle"/>
        AND start_site_id = #{entity.startSiteId}
        <if test="lineTypeList != null and lineTypeList.size() > 0">
            AND line_type IN
            <foreach collection="lineTypeList" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="sendVehicleBizList != null and sendVehicleBizList.size() > 0">
            AND biz_id IN
            <foreach collection="sendVehicleBizList" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="entity.lastPlanDepartTimeBegin !=null and entity.lastPlanDepartTimeEnd !=null and entity.createTimeBegin !=null">
            and ((last_plan_depart_time &gt;= #{entity.lastPlanDepartTimeBegin} and last_plan_depart_time &lt;= #{entity.lastPlanDepartTimeEnd}) or (last_plan_depart_time is null and create_time &gt;= #{entity.createTimeBegin}))
        </if>
        GROUP BY vehicle_status
    </select>

    <select id="sumTaskByLineType" resultMap="lineTypeSumResultMap">
        SELECT
        line_type, COUNT(*) total
        FROM
        jy_biz_task_send_vehicle
        WHERE
        yn = 1
        <include refid="default_task_type_vehicle"/>
        AND start_site_id = #{entity.startSiteId}
        <if test="entity.vehicleStatus != null">
            AND vehicle_status = #{entity.vehicleStatus}
        </if>
        <if test="sendVehicleBizList != null and sendVehicleBizList.size() > 0">
            AND biz_id IN
            <foreach collection="sendVehicleBizList" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="entity.lastPlanDepartTimeBegin !=null and entity.lastPlanDepartTimeEnd !=null and entity.createTimeBegin !=null">
            and ((last_plan_depart_time &gt;= #{entity.lastPlanDepartTimeBegin} and last_plan_depart_time &lt;= #{entity.lastPlanDepartTimeEnd}) or (last_plan_depart_time is null and create_time &gt;= #{entity.createTimeBegin}))
        </if>
        GROUP BY line_type
    </select>

    <select id="querySendTaskOfPage" resultMap="jyBizTaskSendVehicleMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        jy_biz_task_send_vehicle
        WHERE

        <include refid="taskQueryCondition"/>
        <include refid="default_task_type_vehicle"/>
        <if test="sortType != null">
            ORDER BY
            <choose>
                <when test="sortType == 1">
                    last_plan_depart_time DESC
                </when>
                <when test="sortType == 2">
                    last_seal_car_time DESC
                </when>
                <otherwise>
                    id
                </otherwise>
            </choose>
        </if>

        LIMIT #{offset},#{limit}
    </select>

    <select id="countByCondition" resultType="java.lang.Integer">
        SELECT
        COUNT(*)
        FROM jy_biz_task_send_vehicle
        WHERE
        <include refid="taskQueryCondition"/>
        <include refid="default_task_type_vehicle"/>
    </select>

    <sql id="taskQueryCondition">
        yn = 1
        AND start_site_id = #{entity.startSiteId}
        <if test="lineTypeList != null and lineTypeList.length > 0">
            AND line_type IN
            <foreach collection="lineTypeList" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="sendVehicleBizList != null and sendVehicleBizList.length > 0">
            AND biz_id IN
            <foreach collection="sendVehicleBizList" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="statuses != null and statuses.length > 0">
            AND vehicle_status IN
            <foreach collection="statuses" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="entity.manualCreatedFlag != null">
            AND manual_created_flag = #{entity.manualCreatedFlag}
        </if>
        <if test="entity.lastPlanDepartTimeBegin !=null and entity.lastPlanDepartTimeEnd !=null and entity.createTimeBegin !=null">
            and ((last_plan_depart_time &gt;= #{entity.lastPlanDepartTimeBegin} and last_plan_depart_time &lt;= #{entity.lastPlanDepartTimeEnd}) or (last_plan_depart_time is null and create_time &gt;= #{entity.createTimeBegin}))
        </if>
    </sql>


    <update id="updateStatusWithoutCompare">
        UPDATE jy_biz_task_send_vehicle
        <trim prefix="set" suffixOverrides=",">
            <if test="entity.updateTime != null">
                update_time = #{entity.updateTime},
            </if>
            <if test="entity.updateUserErp != null">
                update_user_erp = #{entity.updateUserErp},
            </if>
            <if test="entity.updateUserName != null">
                update_user_name = #{entity.updateUserName},
            </if>
            <if test="entity.vehicleStatus != null">
                vehicle_status = #{entity.vehicleStatus},
            </if>
            <if test="entity.lastSealCarTime != null">
                last_seal_car_time = #{entity.lastSealCarTime},
            </if>
        </trim>
        WHERE
        yn = 1
        AND biz_id = #{entity.bizId}
        <if test="entity.startSiteId != null">
            AND start_site_id = #{entity.startSiteId}
        </if>
        AND vehicle_status = #{oldStatus}
    </update>

    <update id="updateStatus">
        UPDATE jy_biz_task_send_vehicle
        <trim prefix="set" suffixOverrides=",">
            <if test="entity.updateTime != null">
                update_time = #{entity.updateTime},
            </if>
            <if test="entity.updateUserErp != null">
                update_user_erp = #{entity.updateUserErp},
            </if>
            <if test="entity.updateUserName != null">
                update_user_name = #{entity.updateUserName},
            </if>
            <if test="entity.vehicleStatus != null">
                vehicle_status = #{entity.vehicleStatus},
            </if>
            <if test="entity.lastSealCarTime != null">
                last_seal_car_time = #{entity.lastSealCarTime},
            </if>
        </trim>
        WHERE
        yn = 1
        AND biz_id = #{entity.bizId}
        <if test="entity.startSiteId != null">
            AND start_site_id = #{entity.startSiteId}
        </if>
        AND vehicle_status = #{oldStatus}
        AND vehicle_status <![CDATA[ < ]]> #{entity.vehicleStatus}
    </update>

    <update id="updateBizTaskSendStatus">
        update jy_biz_task_send_vehicle
        set vehicle_status =#{vehicleStatus},
            update_time    = NOW()
        where biz_id = #{bizId}
          and vehicle_status = #{preVehicleStatus}
    </update>

    <select id="findSendTaskByDestOfPage" resultMap="jyBizTaskSendVehicleMap">
        SELECT
        m.id,
        m.biz_id,m.trans_work_code,m.start_site_id,m.vehicle_number,m.vehicle_status,m.manual_created_flag,m.abnormal_flag,
        m.bind_flag,m.trans_way,m.trans_way_name,m.vehicle_type,m.vehicle_type_name,m.line_type,m.line_type_name,m.last_plan_depart_time,m.last_seal_car_time
        FROM
        jy_biz_task_send_vehicle m
        INNER JOIN jy_biz_task_send_vehicle_detail d ON m.biz_id = d.send_vehicle_biz_id
        WHERE
        m.yn = 1
        AND m.task_type = 1 <!-- 仅过滤发车任务 -->
        AND m.manual_created_flag = 0
        <!--AND m.line_type in (1,2)-->
        <if test="entity.lineTypeList != null and entity.lineTypeList.size() > 0">
            AND m.line_type in
            <foreach collection="entity.lineTypeList" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
        </if>
        AND d.yn = 1
        AND d.start_site_id = #{entity.startSiteId, jdbcType=BIGINT}
        <if test="entity.transferFlag!=null and entity.transferFlag ==2">
        AND d.excep_label =0
        </if>
        <if test="entity.endSiteId != null">
            AND d.end_site_id = #{entity.endSiteId, jdbcType=BIGINT}
        </if>
        <if test="entity.transWorkItemCode != null and entity.transWorkItemCode !='' ">
            AND d.trans_work_item_code = #{entity.transWorkItemCode}
        </if>
        <if test="entity.transWorkCodeList != null">
            AND m.trans_work_code IN
            <foreach collection="entity.transWorkCodeList" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="entity.sendVehicleBizId != null">
            AND d.send_vehicle_biz_id = #{entity.sendVehicleBizId}
        </if>
        <if test="entity.lastPlanDepartTimeBegin !=null and entity.lastPlanDepartTimeEnd !=null and entity.createTimeBegin !=null">
            AND ((m.last_plan_depart_time &gt;= #{entity.lastPlanDepartTimeBegin} and m.last_plan_depart_time &lt;= #{entity.lastPlanDepartTimeEnd}) or (m.last_plan_depart_time is null and m.create_time &gt;= #{entity.createTimeBegin}))
        </if>
        AND d.vehicle_status IN ( 0, 1, 2 )
        GROUP BY m.biz_id
        ORDER BY m.last_plan_depart_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="countSendTaskByDest" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM (
                 SELECT m.id,
                        m.biz_id
                 FROM jy_biz_task_send_vehicle m
                          INNER JOIN jy_biz_task_send_vehicle_detail d ON m.biz_id = d.send_vehicle_biz_id
                 WHERE m.yn = 1
                    AND m.task_type = 1 <!-- 仅过滤发车任务 -->
                   AND m.manual_created_flag = 0
                   <!--AND m.line_type in (1,2)-->
                    <if test="lineTypeList != null and lineTypeList.size() > 0">
                        AND m.line_type in
                        <foreach collection="lineTypeList" separator="," open="(" close=")" item="item">
                            #{item}
                        </foreach>
                    </if>
                   AND d.yn = 1
                   AND d.start_site_id = #{startSiteId, jdbcType=BIGINT}
                   AND d.end_site_id = #{endSiteId, jdbcType=BIGINT}
                   AND d.vehicle_status IN (0, 1, 2) and d.excep_label =0
                    <if test="lastPlanDepartTimeBegin !=null and lastPlanDepartTimeEnd !=null and createTimeBegin !=null">
                        and ((m.last_plan_depart_time &gt;= #{lastPlanDepartTimeBegin} and m.last_plan_depart_time &lt;= #{lastPlanDepartTimeEnd}) or (m.last_plan_depart_time is null and m.create_time &gt;= #{createTimeBegin}))
                    </if>
                 GROUP BY m.biz_id
             ) t
    </select>
    <select id="findSendTaskByTransWorkCode" resultMap="jyBizTaskSendVehicleMap">
        select
        <include refid="Base_Column_List"/>
        from jy_biz_task_send_vehicle
        where yn = 1
        <include refid="default_task_type_vehicle"/>
        AND start_site_id = #{startSiteId}
        <if test="transWorkCodeList != null and transWorkCodeList.size() > 0">
            AND trans_work_code IN
            <foreach collection="transWorkCodeList" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
        </if>
    </select>
    <select id="countBizNumForCheckLineType" resultType="java.lang.Integer">
        SELECT
        COUNT(*) bizNum
        FROM
        jy_biz_task_send_vehicle
        WHERE
        yn = 1
        AND biz_id IN
        <foreach collection="sendVehicleBizList" separator="," open="(" close=")" item="item">
            #{item}
        </foreach>
        AND start_site_id = #{entity.startSiteId}
        AND manual_created_flag = #{entity.manualCreatedFlag}
        AND line_type IN
        <foreach collection="lineTypeList" separator="," open="(" close=")" item="item">
            #{item}
        </foreach>
       and create_time &gt;= #{entity.createTimeBegin}
    </select>
    
    <select id="findSendTaskByBizIds" resultMap="jyBizTaskSendVehicleMap">
        select
        <include refid="Base_Column_List"/>
        from jy_biz_task_send_vehicle
        where yn = 1
        and biz_id in
        <foreach collection="bizIds" separator="," open="(" close=")" item="item">
            #{item}
        </foreach>
    </select>

    <select id="findSendTaskByDestAndStatusesWithPage" resultMap="jyBizTaskSendVehicleMap">
        SELECT
        m.id,
        m.biz_id,m.trans_work_code,m.start_site_id,m.vehicle_number,m.vehicle_status,m.manual_created_flag,m.abnormal_flag,
        m.bind_flag,m.trans_way,m.trans_way_name,m.vehicle_type,m.vehicle_type_name,m.line_type,m.line_type_name,m.last_plan_depart_time,m.last_seal_car_time
        FROM
        jy_biz_task_send_vehicle m
        INNER JOIN jy_biz_task_send_vehicle_detail d ON m.biz_id = d.send_vehicle_biz_id
        WHERE
        m.yn = 1
        <if test="entity.lineTypeList != null and entity.lineTypeList.size() > 0">
            AND m.line_type in
            <foreach collection="entity.lineTypeList" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="entity.manualCreatedFlag != null">
            AND m.manual_created_flag = #{entity.manualCreateFlag}
        </if>
        AND d.yn = 1
        AND d.start_site_id = #{entity.startSiteId, jdbcType=BIGINT}
        <if test="entity.transferFlag!=null and entity.transferFlag ==2">
            AND d.excep_label =0
        </if>
        AND d.end_site_id = #{entity.endSiteId, jdbcType=BIGINT}
        <if test="entity.transWorkItemCode != null and entity.transWorkItemCode !='' ">
            AND d.trans_work_item_code = #{entity.transWorkItemCode}
        </if>
        <if test="entity.transWorkCodeList != null">
            AND m.trans_work_code IN
            <foreach collection="entity.transWorkCodeList" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="entity.sendVehicleBizId != null">
            AND d.send_vehicle_biz_id = #{entity.sendVehicleBizId}
        </if>
        <if test="entity.lastPlanDepartTimeBegin !=null and entity.lastPlanDepartTimeEnd !=null and entity.createTimeBegin !=null">
            AND ((m.last_plan_depart_time &gt;= #{entity.lastPlanDepartTimeBegin} and m.last_plan_depart_time &lt;= #{entity.lastPlanDepartTimeEnd}) or (m.last_plan_depart_time is null and m.create_time &gt;= #{entity.createTimeBegin}))
        </if>
        <if test="statuses != null and statuses.length > 0">
            AND m.vehicle_status IN
            <foreach collection="statuses" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
        </if>
        GROUP BY m.biz_id
        ORDER BY m.last_plan_depart_time DESC
        LIMIT #{offset}, #{limit}
    </select>


    <select id="findByBookingCode" parameterType="com.jd.bluedragon.distribution.jy.task.JyBizTaskSendVehicleEntity" resultMap="jyBizTaskSendVehicleMap">
        select <include refid="Base_Column_List"/>
        from jy_biz_task_send_vehicle
        where
            start_site_id = #{startSiteId}
            and booking_code = #{bookingCode}
            and task_type = #{taskType}
            and yn = #{yn}
            <if test="yn != null">
                and yn = #{yn}
            </if>
        limit 1
    </select>


    <select id="pageFindDetailSendTaskByCondition" resultMap="jyBizSendTaskAssociationDto">
        SELECT
            m.trans_work_code,m.vehicle_number,m.last_plan_depart_time,
            d.send_vehicle_biz_id,d.biz_id,d.trans_work_item_code,d.vehicle_status,
            d.start_site_id,d.start_site_name,d.end_site_id,d.end_site_name
        FROM
            jy_biz_task_send_vehicle m
            INNER JOIN jy_biz_task_send_vehicle_detail d
            ON m.biz_id = d.send_vehicle_biz_id
        WHERE
            m.yn = 1
            AND m.start_site_id = #{entity.startSiteId}
            AND m.task_type = 1 <!-- 仅过滤发车任务 -->
            AND m.manual_created_flag = 0
            AND m.line_type in
            <foreach collection="entity.lineTypeList" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
            <if test="entity.bizIdList != null and entity.bizIdList.size() > 0">
                AND m.biz_id IN
                <foreach collection="entity.bizIdList" separator="," open="(" close=")" item="item">
                    #{item}
                </foreach>
            </if>
            and ((m.last_plan_depart_time &gt;= #{entity.lastPlanDepartTimeBegin} and m.last_plan_depart_time &lt;= #{entity.lastPlanDepartTimeEnd}) or (m.last_plan_depart_time is null and m.create_time &gt;= #{entity.createTimeBegin}))
            <!-- detail -->
            AND d.yn = 1
            AND d.vehicle_status IN
            <foreach collection="entity.statusList" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
            and d.excep_label =0
        ORDER BY
            m.last_plan_depart_time DESC
        LIMIT #{offset}, #{limit}
    </select>



    <select id="countDetailSendTaskByCondition" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM (
            SELECT
                d.send_vehicle_biz_id, d.biz_id
            FROM
                jy_biz_task_send_vehicle m
                INNER JOIN jy_biz_task_send_vehicle_detail d
                ON m.biz_id = d.send_vehicle_biz_id
            WHERE
                m.yn = 1
                AND m.start_site_id = #{startSiteId}
                AND m.task_type = 1 <!-- 仅过滤发车任务 -->
                AND m.manual_created_flag = 0
                AND m.line_type in
                <foreach collection="lineTypeList" separator="," open="(" close=")" item="item">
                    #{item}
                </foreach>
                <if test="bizIdList != null and bizIdList.size() > 0">
                    AND m.biz_id IN
                    <foreach collection="bizIdList" separator="," open="(" close=")" item="item">
                        #{item}
                    </foreach>
                </if>
                AND ((m.last_plan_depart_time &gt;= #{lastPlanDepartTimeBegin} and m.last_plan_depart_time &lt;= #{lastPlanDepartTimeEnd}) or (m.last_plan_depart_time is null and m.create_time &gt;= #{createTimeBegin}))
                <!-- detail -->
                AND d.yn = 1
                AND d.vehicle_status IN
                <foreach collection="statusList" separator="," open="(" close=")" item="item">
                    #{item}
                </foreach>
                and d.excep_label =0
        ) t
    </select>


</mapper>
