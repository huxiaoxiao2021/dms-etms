<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jd.bluedragon.distribution.jy.dao.exception.JyBizTaskExceptionDao">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.jd.bluedragon.distribution.jy.exception.JyBizTaskExceptionEntity" id="jyBizTaskExceptionMap">
        <result property="id" column="id"/>
        <result property="type" column="type"/>
        <result property="bizId" column="biz_id"/>
        <result property="source" column="source"/>
        <result property="barCode" column="bar_code"/>
        <result property="tags" column="tags"/>
        <result property="siteCode" column="site_code"/>
        <result property="siteName" column="site_name"/>
        <result property="floor" column="floor"/>
        <result property="gridNo" column="grid_no"/>
        <result property="gridCode" column="grid_code"/>
        <result property="areaCode" column="area_code"/>
        <result property="areaName" column="area_name"/>
        <result property="handerleErp" column="handler_erp"/>
        <result property="status" column="status"/>
        <result property="processingStatus" column="processing_status"/>
        <result property="distributionType" column="distribution_type"/>
        <result property="distributionTarget" column="distribution_target"/>
        <result property="distributionTime" column="distribution_time"/>
        <result property="processBeginTime" column="process_begin_time"/>
        <result property="processEndTime" column="process_end_time"/>
        <result property="createUserErp" column="create_user_erp"/>
        <result property="createUserName" column="create_user_name"/>
        <result property="updateUserErp" column="update_user_erp"/>
        <result property="updateUserName" column="update_user_name"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="timeOut" column="time_out"/>
        <result property="yn" column="yn"/>
        <result property="ts" column="ts"/>
    </resultMap>
    <resultMap type="com.jd.bluedragon.common.dto.jyexpection.response.StatisticsByStatusDto" id="StatisticStatusResp">
        <result property="status" column="status"/>
        <result property="count" column="count"/>
    </resultMap>
    <sql id="Base_Column_List">
        id
        ,
        biz_id,
        `type`,
        `source`,
        bar_code,
        tags,
        site_code,
        site_name,
        floor,
        grid_no,
        grid_code,
        area_code,
        area_name,
        distribution_type,
        distribution_target,
        distribution_time,
        handler_erp,
        status,
        processing_status,
        process_begin_time,
        process_end_time,
        create_user_erp,
        create_user_name,
        update_user_erp,
        update_user_name,
        create_time,
        update_time,
        time_out,
        ts,
        yn
    </sql>

    <select id="findByBizId" resultMap="jyBizTaskExceptionMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM jy_biz_task_exception
        WHERE
        yn = 1
        AND biz_id = #{bizId, jdbcType=VARCHAR}
    </select>

    <insert id="insert" parameterType="com.jd.bluedragon.distribution.jy.exception.JyBizTaskExceptionEntity">
        INSERT INTO jy_biz_task_exception (
            biz_id,
            `type`,
            `source`,
            bar_code,
            tags,
            site_code,
            site_name,
            floor,
            grid_no,
            grid_code,
            area_code,
            area_name,
            distribution_type,
            distribution_target,
            distribution_time,
            handler_erp,
            status,
            processing_status,
            process_begin_time,
            process_end_time,
            create_user_erp,
            create_user_name,
            update_user_erp,
            update_user_name,
            create_time,
            update_time,
            time_out,
            yn)
        VALUES (
                   #{type},
                   #{bizId},
                   #{source},
                   #{barCode},
                   #{tags},
                   #{siteCode},
                   #{siteName},
                   #{floor},
                   #{gridNo},
                   #{gridCode},
                   #{areaCode},
                   #{areaName},
                   #{handerleErp},
                   #{status},
                   #{processingStatus},
                   #{distributionType},
                   #{distributionTarget},
                   #{distributionTime},
                   #{processBeginTime},
                   #{processEndTime},
                   #{createUserErp},
                   #{createUserName},
                   #{updateUserErp},
                   #{updateUserName},
                   #{createTime},
                   #{updateTime},
                   #{timeOut},
                   1)
    </insert>

    <select id="getStatusStatistic" resultMap="StatisticStatusResp">
        select status,count(*) as `count`
        FROM jy_biz_task_exception
        WHERE
            yn = 1 and status in (0,1,2)
            and distribution_target = #{gridRefId}
        group by status
    </select>

    <update id="updateByBizId">
        UPDATE jy_biz_task_exception
        <set>
            <if test="distributionType != null">
                distribution_type = #{distributionType},
            </if>

            <if test="distributionTarget != null">
                distribution_target = #{distributionTarget},
            </if>

            <if test="distributionTime != null">
                distribution_time = #{distributionTime},
            </if>

            <if test="updateUser != null">
                update_user = #{updateUser},
            </if>
            <if test="updateUserName != null">
                update_user_name = #{updateUserName},
            </if>

            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            <if test="timeOut != null">
                time_out = #{timeOut},
            </if>
            <if test="yn != null">
                yn = #{yn},
            </if>
        </set>
        <where>
            send_vehicle_biz_id = #{sendVehicleBizId}
        </where>
    </update>


    <select id="getStatisticsByGrid" parameterType="com.jd.bluedragon.common.dto.jyexpection.request.StatisticsByGridReq" resultType="com.jd.bluedragon.common.dto.jyexpection.response.StatisticsByGridDto">
        SELECT
        site_code AS siteCode,
        site_name AS siteName,
        floor AS floor,
        grid_code AS gridCode,
        grid_no AS gridNo,
        area_code AS areaCode,
        area_name AS areaName,
        count(*) AS pendingNum,
        SUM(time_out) AS timeoutNum
        FROM jy_biz_task_exception
        WHERE
        yn = 1
        AND site_code = #{siteId}
        AND status = #{status}
        GROUP BY grid_code,floor
        <if test="pageSize !=null">
            LIMIT #{offSet}, #{pageSize};
        </if>
    </select>

    <select id="queryExceptionTaskList" parameterType="com.jd.bluedragon.common.dto.jyexpection.request.ExpTaskPageReq" resultMap="StatisticStatusResp">
        SELECT
        <include refid="Base_Column_List"/>
        FROM jy_biz_task_exception
        WHERE
        yn = 1
        AND site_code = #{siteId}
        AND status = #{status}
        <if test="gridCode !=null and gridCode!=''">
            AND grid_code = #{gridCode}
        </if>
    </select>
</mapper>